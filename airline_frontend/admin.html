<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SkyWings Airlines</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>‚úàÔ∏è Nimbus Airlines - Admin</h1>
            <ul class="nav-links">
                <li><a href="#" id="adminLogoutBtn">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <!-- Admin Login -->
        <div id="adminLoginForm" class="auth-container">
            <h2>Admin Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="text" id="adminUsername" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
            <div id="loginMessage"></div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" style="display:none;">
            <h2>Admin Dashboard</h2>

            <!-- Dashboard Summary -->
            <div class="quick-actions">
                <div class="action-cards">
                    <div class="action-card" id="totalFlightsCard">
                        <div class="action-icon">‚úàÔ∏è</div>
                        <h3>Total Flights</h3>
                        <p id="totalFlights">0</p>
                    </div>
                    <div class="action-card" id="totalBookingsCard">
                        <div class="action-icon">üß≥</div>
                        <h3>Total Bookings</h3>
                        <p id="totalBookings">0</p>
                    </div>
                    <div class="action-card" id="totalRevenueCard">
                        <div class="action-icon">üí∞</div>
                        <h3>Total Revenue</h3>
                        <p id="totalRevenue">‚Çπ0</p>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="admin-tabs" style="margin-top:20px;">
                <button class="tab-btn active" data-tab="flights">Flights</button>
                <button class="tab-btn" data-tab="bookings">Bookings</button>
                <button class="tab-btn" data-tab="passengers">Passengers</button>
                <button class="tab-btn" data-tab="addFlight">Add Flight</button>
            </div>

            <!-- Flights Tab -->
            <div id="flightsTab" class="tab-content active">
                <h3>All Flights</h3>
                <div id="flightsList"></div>
            </div>

            <!-- Bookings Tab -->
            <div id="bookingsTab" class="tab-content">
                <h3>All Bookings</h3>
                <div id="bookingsList"></div>
            </div>

            <!-- Passengers Tab -->
            <div id="passengersTab" class="tab-content">
                <h3>All Passengers</h3>
                <div id="passengersList"></div>
            </div>

            <!-- Add Flight Tab -->
            <div id="addFlightTab" class="tab-content">
                <h3>Add New Flight</h3>
                <form id="addFlightForm" class="admin-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Flight Number</label>
                            <input type="text" id="flightNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Airline</label>
                            <input type="text" id="airline" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Source</label>
                            <input type="text" id="source" required>
                        </div>
                        <div class="form-group">
                            <label>Destination</label>
                            <input type="text" id="destination" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Departure Date</label>
                            <input type="date" id="departureDate" required>
                        </div>
                        <div class="form-group">
                            <label>Departure Time</label>
                            <input type="time" id="departureTime" required>
                        </div>
                        <div class="form-group">
                            <label>Arrival Time</label>
                            <input type="time" id="arrivalTime" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Price (‚Çπ)</label>
                            <input type="number" id="price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Total Seats</label>
                            <input type="number" id="totalSeats" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">Add Flight</button>
                </form>
                <div id="addFlightMessage"></div>
            </div>
        </div>
    </div>
    <script src="js/config.js"></script>
    <script src="js/script.js"></script>
    <script>
        // ‚úÖ FIXED: Check for active user session on page load
        (function() {
            const userSession = localStorage.getItem('passenger');
            if (userSession) {
                alert('‚ö†Ô∏è You are currently logged in as User. Please logout first.');
                window.location.href = 'index.html';
                return;
            }

            // Check if admin is already logged in
            const adminSession = localStorage.getItem('admin');
            if (adminSession) {
                document.getElementById('adminLoginForm').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadFlights();
                loadDashboardSummary();
            }
        })();

        // Tab Switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                const tabName = btn.dataset.tab;
                const tabContent = document.getElementById(tabName + 'Tab');

                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

                tabContent.classList.add('active');
                btn.classList.add('active');

                tabContent.scrollIntoView({ behavior: 'smooth', block: 'start' });

                if(tabName === 'flights') loadFlights();
                if(tabName === 'bookings') {
                    loadBookings();
                    document.getElementById('bookingsList').scrollIntoView({ behavior: 'smooth' });
                }
                if(tabName === 'passengers') {
                    loadPassengers();
                    document.getElementById('passengersList').scrollIntoView({ behavior: 'smooth' });
                }

                if(tabName === 'addFlight') {
                    editingFlightId = null;
                    document.getElementById('addFlightForm').reset();
                    document.querySelector('#addFlightTab h3').innerText = 'Add a Flight';
                    document.querySelector('#addFlightForm button[type="submit"]').innerText = 'Add Flight';
                }
            });
        });

        // Admin Login
        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault();

            // ‚úÖ FIXED: Check for user session before admin login
            if (localStorage.getItem('passenger')) {
                document.getElementById('loginMessage').innerHTML = '<p class="error">‚ùå User session active. Please logout from user account first.</p>';
                return;
            }

            const email = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await fetch(CONFIG.API_BASE_URL + '/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if(response.ok){
                    clearAllSessions(); // ‚úÖ Clear any lingering sessions
                    localStorage.setItem('admin', JSON.stringify(data)); // ‚úÖ Store admin session
                    document.getElementById('adminLoginForm').style.display='none';
                    document.getElementById('adminDashboard').style.display='block';
                    loadFlights();
                    loadDashboardSummary();
                } else {
                    document.getElementById('loginMessage').innerHTML = `<p class="error">${data.message}</p>`;
                }
            } catch(error){
                document.getElementById('loginMessage').innerHTML = `<p class="error">Server connection error</p>`;
            }
        });

        // ‚úÖ FIXED: Admin Logout - Redirect to homepage
        document.getElementById('adminLogoutBtn').addEventListener('click', () => {
            clearAllSessions();
            window.location.href = 'index.html';
        });

        // Dashboard Summary
        async function loadDashboardSummary(){
            try{
                const flights = await (await fetch(CONFIG.API_BASE_URL + '/api/flights')).json();
                const bookings = await (await fetch(CONFIG.API_BASE_URL + '/api/bookings')).json();
                const totalRevenue = bookings.reduce((sum,b)=>sum+b.totalAmount,0);

                document.getElementById('totalFlights').innerText = flights.length;
                document.getElementById('totalBookings').innerText = bookings.length;
                document.getElementById('totalRevenue').innerText = `‚Çπ${totalRevenue}`;
            } catch(err){
                console.log(err);
            }
        }

        // Load Flights Table
        async function loadFlights(){
            try{
                const flights = await (await fetch(CONFIG.API_BASE_URL + '/api/flights')).json();
                document.getElementById('flightsList').innerHTML = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th><th>Flight No</th><th>Airline</th>
                                <th>Route</th><th>Date</th><th>Time</th>
                                <th>Price</th><th>Seats</th><th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        ${flights.map(f=>`
                            <tr>
                                <td>${f.id}</td>
                                <td>${f.flightNumber}</td>
                                <td>${f.airline}</td>
                                <td>${f.source} ‚Üí ${f.destination}</td>
                                <td>${f.departureDate}</td>
                                <td>${f.departureTime}</td>
                                <td>‚Çπ${f.price}</td>
                                <td>${f.availableSeats}/${f.totalSeats}</td>
                                <td>
                                    <button class="btn btn-secondary" onclick="editFlight(${f.id})">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteFlight(${f.id})">Delete</button>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                `;
            } catch(err){console.log(err);}
        }

        // Load Bookings Table
        async function loadBookings(){
            try{
                const bookings = await (await fetch(CONFIG.API_BASE_URL + '/api/bookings')).json();
                document.getElementById('bookingsList').innerHTML = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th><th>Passenger</th><th>Flight</th>
                                <th>Seats</th><th>Amount</th><th>Status</th><th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                        ${bookings.map(b=>`
                            <tr>
                                <td>${b.id}</td>
                                <td>${b.passenger.firstName} ${b.passenger.lastName}</td>
                                <td>${b.flight.flightNumber}</td>
                                <td>${b.numberOfSeats}</td>
                                <td>‚Çπ${b.totalAmount}</td>
                                <td><span class="status-badge ${b.status.toLowerCase()}">${b.status}</span></td>
                                <td>${new Date(b.bookingDate).toLocaleDateString()}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                `;
            } catch(err){console.log(err);}
        }

        // Load Passengers Table
        async function loadPassengers(){
            try{
                const passengers = await (await fetch(CONFIG.API_BASE_URL + '/api/passengers')).json();
                document.getElementById('passengersList').innerHTML = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th><th>Name</th><th>Email</th>
                                <th>Phone</th><th>Age</th><th>Gender</th>
                            </tr>
                        </thead>
                        <tbody>
                        ${passengers.map(p=>`
                            <tr>
                                <td>${p.id}</td>
                                <td>${p.firstName} ${p.lastName}</td>
                                <td>${p.email}</td>
                                <td>${p.phone}</td>
                                <td>${p.age||'N/A'}</td>
                                <td>${p.gender||'N/A'}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                `;
            } catch(err){console.log(err);}
        }

        document.getElementById('addFlightForm').addEventListener('submit', async e => {
            e.preventDefault();
            
            const flightData = {
                flightNumber: document.getElementById('flightNumber').value,
                airline: document.getElementById('airline').value,
                source: document.getElementById('source').value.toUpperCase(),
                destination: document.getElementById('destination').value.toUpperCase(),
                departureDate: document.getElementById('departureDate').value,
                departureTime: document.getElementById('departureTime').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                price: parseFloat(document.getElementById('price').value),
                totalSeats: parseInt(document.getElementById('totalSeats').value)
            };

            try {
                let response;
                if (editingFlightId) {
                    response = await fetch(`${CONFIG.API_BASE_URL}/api/flights/${editingFlightId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(flightData)
                    });
                } else {
                    response = await fetch(CONFIG.API_BASE_URL + '/api/flights', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(flightData)
                    });
                }

                if (response.ok) {
                    document.getElementById('addFlightMessage').innerHTML = `<p class="success">${editingFlightId ? 'Flight updated' : 'Flight added'} successfully!</p>`;
                    document.getElementById('addFlightForm').reset();
                    editingFlightId = null;
                    loadFlights();
                    loadDashboardSummary();
                    setTimeout(() => document.getElementById('addFlightMessage').innerHTML = '', 3000);
                } else {
                    const data = await response.json();
                    document.getElementById('addFlightMessage').innerHTML = `<p class="error">${data.message || 'Error saving flight'}</p>`;
                }
            } catch (err) {
                console.error(err);
                document.getElementById('addFlightMessage').innerHTML = '<p class="error">Server connection error</p>';
            }
        });

        let editingFlightId = null;

        async function deleteFlight(id) {
            if (!confirm('Are you sure you want to delete this flight?')) return;

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/flights/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Flight deleted successfully!');
                    loadFlights();
                    loadDashboardSummary();
                } else {
                    const data = await response.json();
                    alert(`Error: ${data.message || 'Could not delete flight'}`);
                }
            } catch (err) {
                console.error(err);
                alert('Server connection error');
            }
        }

        async function editFlight(id){
            const flights = await (await fetch(CONFIG.API_BASE_URL + '/api/flights')).json();
            const flight = flights.find(f => f.id === id);
            if(!flight) return alert('Flight not found');

            document.getElementById('flightNumber').value = flight.flightNumber;
            document.getElementById('airline').value = flight.airline;
            document.getElementById('source').value = flight.source;
            document.getElementById('destination').value = flight.destination;
            document.getElementById('departureDate').value = flight.departureDate;
            document.getElementById('departureTime').value = flight.departureTime;
            document.getElementById('arrivalTime').value = flight.arrivalTime;
            document.getElementById('price').value = flight.price;
            document.getElementById('totalSeats').value = flight.totalSeats;

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('addFlightTab').classList.add('active');
            document.querySelector('[data-tab="addFlight"]').classList.add('active');

            editingFlightId = id;

            document.querySelector('#addFlightTab h3').innerText = 'Edit Flight';
            document.querySelector('#addFlightForm button[type="submit"]').innerText = 'Save Changes';
        }
    </script>
</body>
</html>